#!/bin/bash

# novam - Project Nova CLI Management Tool
# Usage: novam [api|player|update|status]

# Resolve script directory to handle relative paths
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PROJECT_ROOT="$SCRIPT_DIR"

cd "$PROJECT_ROOT"

# Load virtual environment if it exists
if [ -d "venv" ]; then
    source venv/bin/activate
fi

case "$1" in
    api)
        echo "ðŸš€ Starting Project Nova API Service..."
        python3 core/run.py
        ;;
    player)
        # Check if engine is running
        if ! curl -s http://localhost:5001/api/v1/health > /dev/null; then
            echo "âš™ï¸  Nova Engine is not running. Starting it in background..."
            nohup python3 core/run.py > core.log 2>&1 &
            echo "â³ Waiting for engine to warm up..."
            sleep 4
        fi
        echo "ðŸŽµ Opening Nova Player..."
        open http://localhost:5001/player
        ;;
    update)
        echo "ðŸ”„ Checking for Project Nova updates..."
        git pull origin main
        echo "âœ… Update complete."
        ;;
    status)
        if curl -s http://localhost:5001/api/v1/health > /dev/null; then
            echo "ðŸŸ¢ Nova Engine: RUNNING"
            echo "ðŸ”— Local Endpoint: http://localhost:5001"
            echo "ðŸ”— Player UI: http://localhost:5001/player"
        else
            echo "ðŸ”´ Nova Engine: OFFLINE"
        fi
        ;;
    *)
        echo "Usage: novam {api|player|update|status}"
        echo ""
        echo "Commands:"
        echo "  api      Start the core API service"
        echo "  player   Start the service (if needed) and open the web player"
        echo "  update   Pull the latest features from GitHub"
        echo "  status   Check if the Nova Engine is healthy"
        exit 1
        ;;
esac
