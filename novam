#!/bin/bash

# novam - Project Nova CLI Management Tool
# Usage: novam [api|player|update|status]

# Resolve script directory to handle relative paths
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PROJECT_ROOT="$SCRIPT_DIR"

cd "$PROJECT_ROOT"

# Load virtual environment if it exists
if [ -d "venv" ]; then
    source venv/bin/activate
fi

# Colors for UI
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

case "$1" in
    api)
        echo -e "${BLUE}ðŸš€ Starting Project Nova API Service...${NC}"
        python3 core/run.py
        ;;
    player|dashboard)
        # Check if engine is running
        if ! curl -s http://localhost:5001/api/v1/health > /dev/null; then
            echo -e "${BLUE}âš™ï¸  Nova Engine is not running. Starting it in background...${NC}"
            # Kill any zombie processes on port 5001
            lsof -ti :5001 | xargs kill -9 2>/dev/null || true
            nohup python3 core/run.py > core.log 2>&1 &
            echo -e "${BLUE}â³ Waiting for engine to warm up...${NC}"
            sleep 3
        fi
        echo -e "${GREEN}ðŸŽµ Opening Nova Dashboard...${NC}"
        open http://localhost:5001/player/
        ;;
    update)
        echo -e "${BLUE}ðŸ”„ Checking for Project Nova updates...${NC}"
        git pull origin main
        echo -e "${GREEN}âœ… Update complete.${NC}"
        ;;
    status)
        if curl -s http://localhost:5001/api/v1/health > /dev/null; then
            echo -e "${GREEN}ðŸŸ¢ Nova Engine: RUNNING${NC}"
            echo -e "${BLUE}ðŸ”— API Endpoint:${NC} http://localhost:5001/api/v1"
            echo -e "${BLUE}ðŸ”— Dashboard:${NC}    http://localhost:5001/player/"
        else
            echo -e "${RED}ðŸ”´ Nova Engine: OFFLINE${NC}"
        fi
        ;;
    *)
        echo -e "${BLUE}Project Nova Management Tool${NC}"
        echo "Usage: ./novam {api|dashboard|update|status}"
        echo ""
        echo "Commands:"
        echo "  api        Start the core API service (foreground)"
        echo "  dashboard  Launch the Nova Dashboard (search, play, lyrics)"
        echo "  update     Sync with latest features from GitHub"
        echo "  status     Check health and endpoints"
        exit 1
        ;;
esac
